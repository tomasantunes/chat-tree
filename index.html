<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Tree Web App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            overflow: auto;
            padding: 20px;
        }
        .tree-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            position: relative;
            padding: 10px 0;
        }
        .tree-row::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            border-top: 2px dashed #e0e0e0;
        }
        .tree-row:first-child::before {
            display: none;
        }
        .chat-node {
            display: inline-block;
            margin: 10px;
            padding: 15px;
            border: 2px solid #007bff;
            border-radius: 10px;
            width: 300px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .chat-node:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }
        .chat-node.system {
            border-color: #28a745;
            background: #f0fff4;
        }
        .chat-node.user {
            border-color: #007bff;
            background: #f0f8ff;
        }
        .chat-node.ai {
            border-color: #ffc107;
            background: #fffef0;
        }
        .chat-node.selected {
            border-color: #dc3545;
            border-width: 3px;
            box-shadow: 0 4px 16px rgba(220, 53, 69, 0.3);
        }
        .node-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .node-content {
            color: #555;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .depth-label {
            text-align: center;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .plus-button {
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #28a745;
            color: white;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.2s;
            z-index: 10;
        }
        .plus-button:hover {
            background: #218838;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .inject-prompt-container {
            text-align: center;
            margin: 10px auto 15px;
            max-width: 600px;
        }
        .inject-prompt-label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }
        .inject-prompt-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .inject-prompt-input:focus {
            outline: none;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Chat Tree Web App</h1>
        <div id="chatTree" class="chat-container"></div>
        <div class="mt-4">
            <form id="chatForm" class="d-flex flex-column align-items-center">
                <textarea id="userInput" class="form-control mb-2" rows="3" placeholder="Type your message here..."></textarea>
                <select id="systemPrompt" class="form-select mb-2">
                    <option value="prompt1">Provide answers as short and concise as possible.</option>
                    <option value="prompt2">Be funny in your responses.</option>
                    <option value="prompt3">Provide historical evidence of your answers.</option>
                </select>
                <input type="hidden" value="0" id="message_id">
                <button type="submit" class="btn btn-primary">Send</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const chatTree = document.getElementById('chatTree');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const systemPrompt = document.getElementById('systemPrompt');
        let currentId = 0;
        let tree = null;
        let selectedNodeId = null;

        chatForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const userMessage = userInput.value.trim();
            const selectedPrompt = systemPrompt.options[systemPrompt.selectedIndex].text;

            if (userMessage) {

                if (tree == null) {
                    // Initialize tree with system prompt and first user message
                    tree = {
                        id: currentId,
                        content: selectedPrompt,
                        replies: [
                            {
                                id: currentId + 1,
                                content: userMessage,
                                replies: []
                            }
                        ],
                    }
                    currentId += 2; // Skip both system (0) and first user message (1)
                    selectedNodeId = 1; // Select the first user message
                } else {
                    // Add new user message to the selected node (or last node if none selected)
                    const targetId = selectedNodeId !== null ? selectedNodeId : currentId - 1;
                    addReplyById(tree, targetId, {
                        id: currentId,
                        content: userMessage,
                        replies: []
                    });
                    currentId++;
                    selectedNodeId = currentId - 1; // Select the newly added user message
                }
                
                // Build message thread from root to current selected node
                let messages = [];
                const thread_of_messages = getPathToNode(tree, selectedNodeId);
                messages = thread_of_messages.map(msg => {
                    return { role: msg.id === 0 ? 'system' : (msg.id % 2 === 1 ? 'user' : 'assistant'), content: msg.content };
                });
                
                const response = await getChatResponse(messages);

                // Add AI response as reply to current user message
                addReplyById(tree, selectedNodeId, {
                    id: currentId,
                    content: response.content,
                    replies: []
                });
                selectedNodeId = currentId; // Select the AI response for the next message
                currentId++;

                renderTree();
                userInput.value = '';
            }
        });

        function renderTree() {
            chatTree.innerHTML = '';
            if (!tree) return;

            // Group nodes by depth
            const nodesByDepth = [];
            
            function traverse(node, depth) {
                if (!nodesByDepth[depth]) {
                    nodesByDepth[depth] = [];
                }
                nodesByDepth[depth].push(node);
                
                for (const reply of node.replies || []) {
                    traverse(reply, depth + 1);
                }
            }
            
            traverse(tree, 0);
            
            // Render each depth level as a row
            nodesByDepth.forEach((nodes, depth) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'tree-row';
                
                const depthLabel = document.createElement('div');
                depthLabel.className = 'depth-label';
                depthLabel.textContent = depth === 0 ? 'System Prompt' : 
                                        depth === 1 ? 'Messages (Depth 1)' : 
                                        `Messages (Depth ${depth})`;
                chatTree.appendChild(depthLabel);
                
                // Add inject prompt input for each depth
                const injectContainer = document.createElement('div');
                injectContainer.className = 'inject-prompt-container';
                
                const injectLabel = document.createElement('div');
                injectLabel.className = 'inject-prompt-label';
                injectLabel.textContent = 'Inject Prompt:';
                
                const injectInput = document.createElement('input');
                injectInput.type = 'text';
                injectInput.className = 'inject-prompt-input';
                injectInput.id = `inject-prompt-${depth}`;
                injectInput.placeholder = 'Enter text to inject into messages at this depth...';
                
                injectContainer.appendChild(injectLabel);
                injectContainer.appendChild(injectInput);
                chatTree.appendChild(injectContainer);
                
                nodes.forEach(node => {
                    const nodeDiv = document.createElement('div');
                    nodeDiv.className = 'chat-node';
                    
                    if (node.id === 0) {
                        nodeDiv.classList.add('system');
                    } else if (node.id % 2 === 1) {
                        nodeDiv.classList.add('user');
                    } else {
                        nodeDiv.classList.add('ai');
                    }
                    
                    if (node.id === selectedNodeId) {
                        nodeDiv.classList.add('selected');
                    }
                    
                    const header = document.createElement('div');
                    header.className = 'node-header';
                    header.textContent = node.id === 0 ? 'System' : 
                                        node.id % 2 === 1 ? 'User' : 'AI';
                    
                    const content = document.createElement('div');
                    content.className = 'node-content';
                    content.textContent = node.content;
                    
                    nodeDiv.appendChild(header);
                    nodeDiv.appendChild(content);
                    
                    // Add plus button to AI nodes
                    if (node.id !== 0 && node.id % 2 === 0) {
                        const plusBtn = document.createElement('div');
                        plusBtn.className = 'plus-button';
                        plusBtn.innerHTML = '+';
                        plusBtn.title = 'Generate another response';
                        plusBtn.addEventListener('click', async (e) => {
                            e.stopPropagation(); // Prevent node selection
                            await generateAlternateResponse(node.id);
                        });
                        nodeDiv.appendChild(plusBtn);
                    }
                    
                    nodeDiv.addEventListener('click', () => {
                        selectedNodeId = node.id;
                        renderTree();
                    });
                    
                    rowDiv.appendChild(nodeDiv);
                });
                
                chatTree.appendChild(rowDiv);
            });
        }

        const OPENAI_API_KEY = "";

        async function generateAlternateResponse(aiNodeId) {
            // Find the parent user message by looking at the path
            const pathToAI = getPathToNode(tree, aiNodeId);
            if (pathToAI.length < 2) return; // Need at least system and user message
            
            // The parent of the AI node is the user message
            const parentUserNode = pathToAI[pathToAI.length - 2];
            
            // Calculate the depth of the AI node (which is pathToAI.length - 1)
            const aiNodeDepth = pathToAI.length - 1;
            
            // Get the inject prompt for the AI node's depth
            const injectInput = document.getElementById(`inject-prompt-${aiNodeDepth}`);
            const injectPrompt = injectInput ? injectInput.value.trim() : '';
            
            console.log('AI Node Depth:', aiNodeDepth);
            console.log('Inject Prompt:', injectPrompt);
            
            // Build the message thread up to the user message
            const pathToUser = getPathToNode(tree, parentUserNode.id);
            const messages = pathToUser.map(msg => {
                let content = msg.content;
                // If this is the last message (the user message we're responding to), inject the prompt
                if (msg.id === parentUserNode.id && injectPrompt) {
                    content = content + ' ' + injectPrompt;
                    console.log('Injected message:', content);
                }
                return { role: msg.id === 0 ? 'system' : (msg.id % 2 === 1 ? 'user' : 'assistant'), content: content };
            });
            
            // Get a new response from the API
            const response = await getChatResponse(messages);
            
            // Ensure AI messages get even IDs
            if (currentId % 2 === 1) {
                currentId++;
            }
            
            // Add the new AI response as a sibling to the current AI node
            addReplyById(tree, parentUserNode.id, {
                id: currentId,
                content: response.content,
                replies: []
            });
            selectedNodeId = currentId;
            currentId++;
            
            renderTree();
        }

        function findNodeById(node, targetId) {
            if (!node) return null;

            if (node.id === targetId) {
                return node;
            }

            for (const reply of node.replies || []) {
                const found = findNodeById(reply, targetId);
                if (found) return found;
            }

            return null;
        }

        function addReplyById(tree, targetId, replyNode) {
            const targetNode = findNodeById(tree, targetId);

            if (!targetNode) {
                throw new Error(`Node with id ${targetId} not found`);
            }

            targetNode.replies.push(replyNode);
        }

        function getPathToNode(root, targetId) {
            const path = [];

            function dfs(node) {
                if (!node) return false;

                // Add current node to path
                path.push(node);

                // Check if this is the target
                if (node.id === targetId) {
                    return true;
                }

                // Search children
                for (const reply of node.replies || []) {
                    if (dfs(reply)) {
                        return true;
                    }
                }

                // Not in this branch â†’ backtrack
                path.pop();
                return false;
            }

            dfs(root);
            return path;
        }


        async function getChatResponse(messages) {
            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                model: "gpt-5-mini",
                messages: messages,
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`OpenAI error: ${errorText}`);
            }

            const data = await response.json();
            return data.choices[0].message;
        }
    </script>
</body>
</html>
